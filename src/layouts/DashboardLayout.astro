---
import Layout from './Layout.astro'
import DashboardNavbar from '../components/dashboard/DashboardNavbar'
import DashboardSidebar from '../components/dashboard/DashboardSidebar'
import { TrialBanner } from '../components/dashboard/TrialBanner'
import { supabase } from '../lib/supabase'

interface Props {
  title: string
}

const { title } = Astro.props
const currentPath = Astro.url.pathname

// Obtener información del trial del usuario actual
let showTrialBanner = false
let trialDays = 0
let storeId = ''

try {
  // Intentar obtener la sesión del usuario
  const authHeader = Astro.request.headers.get('cookie')
  
  if (authHeader) {
    const { data: { user } } = await supabase.auth.getUser()
    
    if (user) {
      // Obtener la tienda del usuario
      const { data: store } = await supabase
        .from('stores')
        .select('id')
        .eq('user_id', user.id)
        .single()
      
      if (store) {
        storeId = store.id
        
        // Obtener la suscripción
        const { data: subscription } = await supabase
          .from('subscriptions')
          .select('plan_id, status, trial_ends_at')
          .eq('store_id', store.id)
          .single()
        
        if (subscription && subscription.status === 'trial' && subscription.trial_ends_at) {
          const trialEnd = new Date(subscription.trial_ends_at)
          const now = new Date()
          
          if (trialEnd > now) {
            showTrialBanner = true
            const diffMs = trialEnd.getTime() - now.getTime()
            trialDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24))
          }
        }
      }
    }
  }
} catch (error) {
  console.error('Error checking trial status:', error)
}
---

<Layout title={title}>
  <div class="h-screen flex flex-col bg-gray-100">
    <!-- Trial Banner -->
    {showTrialBanner && (
      <TrialBanner daysRemaining={trialDays} storeId={storeId} client:load />
    )}
    
    <!-- Navbar en el fondo superior - full width -->
    <DashboardNavbar client:load currentPath={currentPath} />
    
    <!-- Contenedor principal - ocupa todo el espacio restante -->
    <div class="flex-1 p-6 overflow-hidden">
      <div class="flex gap-6 h-full">
        <!-- Sidebar como card - altura completa -->
        <DashboardSidebar client:load currentPath={currentPath} />

        <!-- Contenido principal como card -->
        <main class="flex-1 overflow-auto">
          <div class="px-6">
            <slot />
          </div>
        </main>
      </div>
    </div>
  </div>
</Layout>
