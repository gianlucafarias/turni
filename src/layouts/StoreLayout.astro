---
import Layout from './Layout.astro';
import CartSlideOver from '../components/store/CartSlideOver.astro';

interface Props {
  title: string;
  storeId: string;
  whatsappNumber?: string;
}

const { title, storeId, whatsappNumber } = Astro.props;
---

<Layout title={title}>
  <!-- Navbar -->
  <nav class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex">
          <a href={`/${storeId}`} class="flex items-center">
            <span class="text-xl font-bold text-indigo-600">Tienda</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Contenido principal -->
  <slot />

  <!-- Carrito -->
  <CartSlideOver
    isOpen={false}
    items={[]}
    storeWhatsapp={whatsappNumber || ''}
  />

  <!-- Botón flotante del carrito -->
  <button
    id="cart-button"
    class="fixed bottom-4 right-4 bg-indigo-600 text-white p-4 rounded-full shadow-lg hover:bg-indigo-700 transition-colors"
  >
    <div class="relative">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
      <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">
        0
      </span>
    </div>
  </button>
</Layout>

<script>
  // Inicializar estado del carrito
  let cartItems = [];
  let isCartOpen = false;

  // Elementos del DOM
  const cartButton = document.getElementById('cart-button');
  const cartCount = document.getElementById('cart-count');
  const cartSlideOver = document.getElementById('cart-slideover');

  // Cargar carrito del localStorage
  try {
    const savedCart = localStorage.getItem('cart');
    if (savedCart) {
      cartItems = JSON.parse(savedCart);
      updateCartCount();
    }
  } catch (error) {
    console.error('Error loading cart:', error);
  }

  // Actualizar contador del carrito
  function updateCartCount() {
    if (cartCount) {
      const totalItems = cartItems.reduce((acc, item) => acc + item.quantity, 0);
      cartCount.textContent = totalItems.toString();
      cartCount.classList.toggle('hidden', totalItems === 0);
    }
  }

  // Eventos globales del carrito
  document.addEventListener('add-to-cart', (e) => {
    const product = e.detail;
    const existingItem = cartItems.find(item => item.id === product.id);
    
    if (existingItem) {
      existingItem.quantity += 1;
    } else {
      cartItems.push({
        ...product,
        quantity: 1
      });
    }

    localStorage.setItem('cart', JSON.stringify(cartItems));
    updateCartCount();
    openCart();
  });

  // Abrir carrito
  function openCart() {
    if (cartSlideOver) {
      isCartOpen = true;
      cartSlideOver.classList.remove('hidden');
    }
  }

  // Click en el botón del carrito
  cartButton?.addEventListener('click', openCart);

  // Actualizar contador cuando se modifica el carrito
  window.addEventListener('storage', (e) => {
    if (e.key === 'cart') {
      try {
        cartItems = JSON.parse(e.newValue || '[]');
        updateCartCount();
      } catch (error) {
        console.error('Error parsing cart:', error);
      }
    }
  });
</script>

<style>
  #cart-button {
    z-index: 40;
  }
</style> 