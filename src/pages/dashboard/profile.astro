---
import Layout from '../../layouts/Layout.astro';
import DashboardNavbar from '../../components/dashboard/Navbar.astro';

// En desarrollo, no verificar sesión en el servidor (el cliente lo manejará)
let session = null
let store = null

if (import.meta.env.PROD) {
  const { supabase } = await import('../../lib/supabase');
  const { data: { session: serverSession } } = await supabase.auth.getSession();
  
  if (!serverSession) {
    return Astro.redirect('/login');
  }
  
  session = serverSession
  
  const { data: storeData } = await supabase
    .from('stores')
    .select('*')
    .eq('user_id', session.user.id)
    .single();
  
  if (!storeData) {
    return Astro.redirect('/registro');
  }
  
  store = storeData
}
---

<Layout title="Mi Perfil">
  <DashboardNavbar />
  
  <main class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <div class="bg-white rounded-lg shadow p-6">
        <h1 class="text-3xl font-bold mb-8">Mi Perfil</h1>

        <div class="grid md:grid-cols-2 gap-8">
          <!-- Información del Usuario -->
          <div>
            <h2 class="text-xl font-semibold mb-4">Información Personal</h2>
            <div class="space-y-4">
              <div>
                <label class="block text-gray-600 mb-1">Email</label>
                <p class="font-medium">{session?.user?.email || 'Cargando...'}</p>
              </div>
              <div>
                <label class="block text-gray-600 mb-1">ID de Usuario</label>
                <p class="font-medium">{session?.user?.id || 'Cargando...'}</p>
              </div>
              <div>
                <label class="block text-gray-600 mb-1">Último acceso</label>
                <p class="font-medium">
                  {session?.user?.last_sign_in_at ? new Date(session.user.last_sign_in_at).toLocaleString() : 'Cargando...'}
                </p>
              </div>
            </div>
          </div>

          <!-- Información de la Tienda -->
          <div>
            <h2 class="text-xl font-semibold mb-4">Información de la Tienda</h2>
            <div class="space-y-4">
              <div>
                <label class="block text-gray-600 mb-1">Nombre de la Tienda</label>
                <p class="font-medium">{store?.name || 'Cargando...'}</p>
              </div>
              <div>
                <label class="block text-gray-600 mb-1">Tipo de Tienda</label>
                <p class="font-medium">
                  {store?.store_type === 'products' ? 'Productos' : store?.store_type === 'appointments' ? 'Turnos' : 'Cargando...'}
                </p>
              </div>
              <div>
                <label class="block text-gray-600 mb-1">Plan Actual</label>
                <p class="font-medium capitalize">{store?.plan || 'Cargando...'}</p>
              </div>
              <div>
                <label class="block text-gray-600 mb-1">Fecha de Creación</label>
                <p class="font-medium">
                  {store?.created_at ? new Date(store.created_at).toLocaleDateString() : 'Cargando...'}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Acciones -->
        <div class="mt-8 pt-6 border-t">
          <h2 class="text-xl font-semibold mb-4">Acciones</h2>
          <div class="space-x-4">
            <button
              type="button"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
              onclick="alert('Función en desarrollo')"
            >
              Cambiar Contraseña
            </button>
            <button
              type="button"
              class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
              onclick="alert('Función en desarrollo')"
            >
              Editar Perfil
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  // Aquí irá la lógica del cliente para manejar las acciones
</script> 