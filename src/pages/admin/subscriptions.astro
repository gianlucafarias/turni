---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Suscripciones - Admin">
  <div id="admin-loading" class="min-h-screen bg-gray-900 flex items-center justify-center">
    <div class="w-10 h-10 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
  </div>

  <div id="admin-denied" class="min-h-screen bg-gray-900 flex items-center justify-center hidden">
    <div class="text-center p-6">
      <h1 class="text-2xl font-bold text-red-500 mb-4">Acceso Denegado</h1>
      <p id="denied-reason" class="text-gray-400 mb-6"></p>
      <a href="/dashboard" class="px-6 py-3 bg-indigo-600 text-white rounded-lg">Volver</a>
    </div>
  </div>

  <div id="admin-content" class="min-h-screen bg-gray-900 hidden">
    <div class="flex">
      <!-- Sidebar -->
      <aside class="w-64 min-h-screen bg-gray-800 border-r border-gray-700 fixed">
        <div class="p-4 border-b border-gray-700">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-orange-500 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
            <div>
              <h1 class="font-bold text-white">Admin Panel</h1>
              <p class="text-xs text-gray-400">Tiendita</p>
            </div>
          </div>
        </div>
        <nav class="p-4 space-y-1">
          <a href="/admin" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-300 hover:bg-gray-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
            Dashboard
          </a>
          <a href="/admin/users" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-300 hover:bg-gray-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
            Usuarios
          </a>
          <a href="/admin/subscriptions" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium bg-indigo-600 text-white">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
            Suscripciones
          </a>
          <a href="/admin/coupons" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-300 hover:bg-gray-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg>
            Cupones
          </a>
          <a href="/admin/plans" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-300 hover:bg-gray-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
            Planes
          </a>
          <div class="pt-4 mt-4 border-t border-gray-700">
            <a href="/dashboard" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-400 hover:bg-gray-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>
              Volver al Dashboard
            </a>
          </div>
        </nav>
      </aside>
      
      <!-- Main -->
      <main class="flex-1 ml-64 p-6">
        <h2 class="text-2xl font-bold text-white mb-6">Gestión de Suscripciones</h2>
        
        <!-- Métricas -->
        <div id="metrics" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
            <p class="text-gray-400 text-sm">MRR Estimado</p>
            <p id="mrr" class="text-2xl font-bold text-emerald-400">$0</p>
          </div>
          <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
            <p class="text-gray-400 text-sm">Premium Activos</p>
            <p id="premium-count" class="text-2xl font-bold text-white">0</p>
          </div>
          <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
            <p class="text-gray-400 text-sm">Free</p>
            <p id="free-count" class="text-2xl font-bold text-white">0</p>
          </div>
          <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
            <p class="text-gray-400 text-sm">Tasa Conversión</p>
            <p id="conversion-rate" class="text-2xl font-bold text-white">0%</p>
          </div>
        </div>

        <!-- Filtros -->
        <div class="flex gap-2 mb-4">
          <button data-filter="all" class="filter-btn px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm">Todos</button>
          <button data-filter="premium" class="filter-btn px-4 py-2 bg-gray-700 text-gray-300 rounded-lg text-sm hover:bg-gray-600">Premium</button>
          <button data-filter="free" class="filter-btn px-4 py-2 bg-gray-700 text-gray-300 rounded-lg text-sm hover:bg-gray-600">Free</button>
        </div>
        
        <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-700/50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Tienda</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Plan</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Estado</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Vencimiento</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">MP ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Acciones</th>
              </tr>
            </thead>
            <tbody id="subs-table" class="divide-y divide-gray-700">
              <tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Cargando...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Pagos recientes -->
        <h3 class="text-xl font-bold text-white mt-8 mb-4">Pagos Recientes</h3>
        <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-700/50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Tienda</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Monto</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Estado</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Fecha</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">MP ID</th>
              </tr>
            </thead>
            <tbody id="payments-table" class="divide-y divide-gray-700">
              <tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Cargando...</td></tr>
            </tbody>
          </table>
        </div>
      </main>
    </div>
  </div>
</Layout>

<script>
  import { createClient } from '@supabase/supabase-js';
  
  const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY
  );

  let allSubs: any[] = [];
  let currentFilter = 'all';

  async function checkAdmin() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return showDenied('No hay sesión activa');
    
    const { data: store } = await supabase.from('stores').select('is_admin').eq('user_id', session.user.id).single();
    if (!store?.is_admin) return showDenied('No sos administrador');
    
    document.getElementById('admin-loading')?.classList.add('hidden');
    document.getElementById('admin-content')?.classList.remove('hidden');
    loadData();
  }

  function showDenied(reason: string) {
    document.getElementById('admin-loading')?.classList.add('hidden');
    document.getElementById('admin-denied')?.classList.remove('hidden');
    const el = document.getElementById('denied-reason');
    if (el) el.textContent = reason;
  }

  async function loadData() {
    // Cargar suscripciones con tienda
    const { data: subs } = await supabase
      .from('subscriptions')
      .select('*, stores(name, slug)')
      .order('created_at', { ascending: false });

    allSubs = subs || [];
    
    // Métricas
    const premium = allSubs.filter(s => s.plan_id === 'premium' || s.plan_id === 'premium_annual');
    const free = allSubs.filter(s => s.plan_id === 'free');
    const mrr = premium.length * 2999; // Precio mensual aproximado
    
    document.getElementById('mrr')!.textContent = `$${(mrr / 100).toLocaleString('es-AR')}`;
    document.getElementById('premium-count')!.textContent = String(premium.length);
    document.getElementById('free-count')!.textContent = String(free.length);
    document.getElementById('conversion-rate')!.textContent = allSubs.length 
      ? `${Math.round((premium.length / allSubs.length) * 100)}%` 
      : '0%';

    renderSubs(allSubs);
    loadPayments();
  }

  function renderSubs(subs: any[]) {
    const tbody = document.getElementById('subs-table');
    if (!tbody) return;

    const filtered = currentFilter === 'all' 
      ? subs 
      : currentFilter === 'premium' 
        ? subs.filter(s => s.plan_id === 'premium' || s.plan_id === 'premium_annual')
        : subs.filter(s => s.plan_id === 'free');

    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">No hay suscripciones</td></tr>';
      return;
    }

    tbody.innerHTML = filtered.map(sub => {
      const statusBadge = getStatusBadge(sub.status);
      const planBadge = getPlanBadge(sub.plan_id);
      const expiry = sub.current_period_end 
        ? new Date(sub.current_period_end).toLocaleDateString('es-AR') 
        : '-';
      
      return `
        <tr class="hover:bg-gray-700/50">
          <td class="px-6 py-4">
            <p class="text-white font-medium">${sub.stores?.name || 'Sin nombre'}</p>
            <p class="text-gray-500 text-sm">@${sub.stores?.slug || '-'}</p>
          </td>
          <td class="px-6 py-4">${planBadge}</td>
          <td class="px-6 py-4">${statusBadge}</td>
          <td class="px-6 py-4 text-gray-400 text-sm">${expiry}</td>
          <td class="px-6 py-4 text-gray-500 text-xs font-mono">${sub.mp_subscription_id || '-'}</td>
          <td class="px-6 py-4">
            <button onclick="changePlan('${sub.store_id}', '${sub.plan_id}')" 
              class="px-3 py-1 text-xs bg-indigo-600 hover:bg-indigo-500 text-white rounded">
              Cambiar Plan
            </button>
          </td>
        </tr>
      `;
    }).join('');
  }

  async function loadPayments() {
    const { data: payments } = await supabase
      .from('subscription_payments')
      .select('*, subscriptions(stores(name))')
      .order('created_at', { ascending: false })
      .limit(20);

    const tbody = document.getElementById('payments-table');
    if (!tbody) return;

    if (!payments?.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No hay pagos registrados</td></tr>';
      return;
    }

    tbody.innerHTML = payments.map(p => {
      const statusBadge = p.status === 'approved' 
        ? '<span class="px-2 py-1 bg-emerald-500/20 text-emerald-400 rounded text-xs">Aprobado</span>'
        : '<span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded text-xs">' + p.status + '</span>';
      
      return `
        <tr class="hover:bg-gray-700/50">
          <td class="px-6 py-4 text-white">${p.subscriptions?.stores?.name || '-'}</td>
          <td class="px-6 py-4 text-emerald-400 font-medium">$${(p.amount / 100).toLocaleString('es-AR')}</td>
          <td class="px-6 py-4">${statusBadge}</td>
          <td class="px-6 py-4 text-gray-400 text-sm">${new Date(p.created_at).toLocaleDateString('es-AR')}</td>
          <td class="px-6 py-4 text-gray-500 text-xs font-mono">${p.mp_payment_id || '-'}</td>
        </tr>
      `;
    }).join('');
  }

  function getStatusBadge(status: string) {
    const badges: Record<string, string> = {
      'active': '<span class="px-2 py-1 bg-emerald-500/20 text-emerald-400 rounded text-xs">Activo</span>',
      'cancelled': '<span class="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs">Cancelado</span>',
      'paused': '<span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded text-xs">Pausado</span>',
      'pending': '<span class="px-2 py-1 bg-gray-500/20 text-gray-400 rounded text-xs">Pendiente</span>',
    };
    return badges[status] || badges['pending'];
  }

  function getPlanBadge(plan: string) {
    const badges: Record<string, string> = {
      'free': '<span class="px-2 py-1 bg-gray-600 text-gray-300 rounded text-xs">Free</span>',
      'premium': '<span class="px-2 py-1 bg-indigo-500/20 text-indigo-400 rounded text-xs">Premium</span>',
      'premium_annual': '<span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs">Premium Anual</span>',
    };
    return badges[plan] || badges['free'];
  }

  (window as any).changePlan = async (storeId: string, currentPlan: string) => {
    const plan = prompt(`Plan actual: ${currentPlan}\nNuevo plan (free, premium, premium_annual):`);
    if (!plan || !['free', 'premium', 'premium_annual'].includes(plan)) return;

    const { error } = await supabase
      .from('subscriptions')
      .update({ 
        plan_id: plan, 
        status: 'active',
        current_period_end: plan !== 'free' ? new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() : null
      })
      .eq('store_id', storeId);

    if (error) alert('Error: ' + error.message);
    else loadData();
  };

  // Filtros
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      currentFilter = target.dataset.filter || 'all';
      
      document.querySelectorAll('.filter-btn').forEach(b => {
        b.classList.remove('bg-indigo-600', 'text-white');
        b.classList.add('bg-gray-700', 'text-gray-300');
      });
      target.classList.remove('bg-gray-700', 'text-gray-300');
      target.classList.add('bg-indigo-600', 'text-white');
      
      renderSubs(allSubs);
    });
  });

  checkAdmin();
</script>
