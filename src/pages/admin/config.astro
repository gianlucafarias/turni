---
// =============================================================================
// Configuración General del Sitio
// =============================================================================

import AdminLayout from '../../layouts/AdminLayout.astro';
import { supabaseAdmin } from '../../lib/supabase';

const supabase = supabaseAdmin;

// Obtener configuración actual
const { data: config } = await supabase
  .from('site_config')
  .select('*')
  .eq('id', 'main')
  .single();
---

<AdminLayout title="Configuración">
  <div class="max-w-2xl space-y-6">
    <!-- Configuración General -->
    <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-700">
        <h3 class="font-semibold text-white">Configuración General</h3>
      </div>
      <form id="generalForm" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1">Nombre del Sitio</label>
          <input
            type="text"
            name="site_name"
            value={config?.site_name || 'Tiendita'}
            class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
          />
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1">Descripción</label>
          <textarea
            name="site_description"
            rows="3"
            class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
          >{config?.site_description || 'Tu negocio online'}</textarea>
        </div>
        
        <div class="flex items-center gap-3">
          <input
            type="checkbox"
            id="maintenance_mode"
            name="maintenance_mode"
            checked={config?.maintenance_mode}
            class="w-4 h-4 text-indigo-600 bg-gray-700 border-gray-600 rounded focus:ring-indigo-500"
          />
          <label for="maintenance_mode" class="text-sm text-gray-300">
            Modo Mantenimiento (desactiva acceso público)
          </label>
        </div>
        
        <div class="flex justify-end">
          <button
            type="submit"
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
          >
            Guardar
          </button>
        </div>
      </form>
    </div>

    <!-- Acciones rápidas -->
    <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-700">
        <h3 class="font-semibold text-white">Acciones</h3>
      </div>
      <div class="p-6 space-y-4">
        <div class="flex items-center justify-between p-4 bg-gray-700/30 rounded-lg">
          <div>
            <p class="text-white font-medium">Ver Logs de Admin</p>
            <p class="text-sm text-gray-400">Historial de acciones administrativas</p>
          </div>
          <button
            onclick="viewLogs()"
            class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors"
          >
            Ver Logs
          </button>
        </div>
        
        <div class="flex items-center justify-between p-4 bg-red-500/10 rounded-lg border border-red-500/20">
          <div>
            <p class="text-red-400 font-medium">Zona de Peligro</p>
            <p class="text-sm text-red-300/70">Acciones que pueden afectar a todos los usuarios</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Info de última actualización -->
    {config?.updated_at && (
      <p class="text-sm text-gray-500 text-center">
        Última actualización: {new Date(config.updated_at).toLocaleString('es-AR')}
      </p>
    )}
  </div>
</AdminLayout>

<script>
  document.getElementById('generalForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    
    try {
      const response = await fetch('/api/admin/config', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'general',
          data: {
            site_name: formData.get('site_name'),
            site_description: formData.get('site_description'),
            maintenance_mode: formData.get('maintenance_mode') === 'on'
          }
        })
      });
      
      if (response.ok) {
        alert('Configuración guardada');
      } else {
        alert('Error al guardar');
      }
    } catch (error) {
      alert('Error al guardar');
    }
  });

  function viewLogs() {
    alert('Función de logs próximamente');
  }

  (window as any).viewLogs = viewLogs;
</script>






