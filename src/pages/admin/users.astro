---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Usuarios - Admin">
  <div id="admin-loading" class="min-h-screen bg-gray-900 flex items-center justify-center">
    <div class="w-10 h-10 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
  </div>

  <div id="admin-denied" class="min-h-screen bg-gray-900 flex items-center justify-center hidden">
    <div class="text-center p-6">
      <h1 class="text-2xl font-bold text-red-500 mb-4">Acceso Denegado</h1>
      <p id="denied-reason" class="text-gray-400 mb-6"></p>
      <a href="/dashboard" class="px-6 py-3 bg-indigo-600 text-white rounded-lg">Volver</a>
    </div>
  </div>

  <div id="admin-content" class="min-h-screen bg-gray-900 hidden">
    <div class="flex">
      <!-- Sidebar -->
      <aside class="w-64 min-h-screen bg-gray-800 border-r border-gray-700 fixed">
        <div class="p-4 border-b border-gray-700">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-orange-500 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
            <div>
              <h1 class="font-bold text-white">Admin Panel</h1>
              <p class="text-xs text-gray-400">Tiendita</p>
            </div>
          </div>
        </div>
        <nav class="p-4 space-y-1">
          <a href="/admin" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-300 hover:bg-gray-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
            Dashboard
          </a>
          <a href="/admin/users" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium bg-indigo-600 text-white">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
            Usuarios
          </a>
          <a href="/admin/subscriptions" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-300 hover:bg-gray-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
            Suscripciones
          </a>
          <a href="/admin/coupons" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-300 hover:bg-gray-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg>
            Cupones
          </a>
          <a href="/admin/plans" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-300 hover:bg-gray-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
            Planes
          </a>
          <div class="pt-4 mt-4 border-t border-gray-700">
            <a href="/dashboard" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-400 hover:bg-gray-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>
              Volver al Dashboard
            </a>
          </div>
        </nav>
      </aside>
      
      <!-- Main -->
      <main class="flex-1 ml-64 p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Gestión de Usuarios</h2>
          <div class="flex gap-2">
            <input type="text" id="search-input" placeholder="Buscar por nombre o email..." 
              class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500">
          </div>
        </div>
        
        <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-700/50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Tienda</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Email</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Plan</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Creado</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Admin</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Acciones</th>
              </tr>
            </thead>
            <tbody id="users-table" class="divide-y divide-gray-700">
              <tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Cargando...</td></tr>
            </tbody>
          </table>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal de cambio de plan -->
  <div id="change-plan-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
    <div class="bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full p-6 border border-gray-700">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-white">Cambiar Plan</h2>
          <p id="modal-store-name" class="text-sm text-gray-400 mt-1"></p>
        </div>
        <button onclick="closeChangePlanModal()" class="p-2 hover:bg-gray-700 rounded-lg transition-colors">
          <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div id="modal-error" class="mb-6 bg-red-500/10 border border-red-500/50 text-red-400 px-4 py-3 rounded-xl hidden"></div>

      <div class="mb-6">
        <p class="text-sm font-medium text-gray-300 mb-3">Plan actual:</p>
        <div id="modal-current-plan" class="px-4 py-3 rounded-xl border-2 border-gray-600 bg-gray-700/50"></div>
      </div>

      <div class="mb-6">
        <p class="text-sm font-medium text-gray-300 mb-3">Seleccionar nuevo plan:</p>
        <div class="space-y-2">
          <button onclick="selectPlan('free')" data-plan="free" class="plan-option w-full text-left px-4 py-3 rounded-xl border-2 border-gray-600 bg-gray-700/50 hover:border-gray-500 transition-all">
            <div class="flex items-center justify-between">
              <div>
                <p class="font-semibold text-white">Free</p>
                <p class="text-xs text-gray-400 mt-0.5">Plan gratuito básico</p>
              </div>
            </div>
          </button>
          <button onclick="selectPlan('trial')" data-plan="trial" class="plan-option w-full text-left px-4 py-3 rounded-xl border-2 border-gray-600 bg-gray-700/50 hover:border-gray-500 transition-all">
            <div class="flex items-center justify-between">
              <div>
                <p class="font-semibold text-white">Trial</p>
                <p class="text-xs text-gray-400 mt-0.5">Plan de prueba</p>
              </div>
            </div>
          </button>
          <button onclick="selectPlan('premium')" data-plan="premium" class="plan-option w-full text-left px-4 py-3 rounded-xl border-2 border-gray-600 bg-gray-700/50 hover:border-gray-500 transition-all">
            <div class="flex items-center justify-between">
              <div>
                <p class="font-semibold text-white">Premium</p>
                <p class="text-xs text-gray-400 mt-0.5">Plan mensual</p>
              </div>
            </div>
          </button>
          <button onclick="selectPlan('premium_annual')" data-plan="premium_annual" class="plan-option w-full text-left px-4 py-3 rounded-xl border-2 border-gray-600 bg-gray-700/50 hover:border-gray-500 transition-all">
            <div class="flex items-center justify-between">
              <div>
                <p class="font-semibold text-white">Premium Anual</p>
                <p class="text-xs text-gray-400 mt-0.5">Plan anual</p>
              </div>
            </div>
          </button>
        </div>
      </div>

      <div class="flex gap-3">
        <button onclick="closeChangePlanModal()" class="flex-1 px-4 py-3 bg-gray-700 text-gray-300 rounded-xl font-semibold hover:bg-gray-600 transition-colors">
          Cancelar
        </button>
        <button onclick="savePlanChange()" id="save-plan-btn" class="flex-1 px-4 py-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          Cambiar Plan
        </button>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { createClient } from '@supabase/supabase-js';
  
  const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY
  );

  let allUsers: any[] = [];

  async function checkAdmin() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return showDenied('No hay sesión activa');
    
    const { data: store } = await supabase.from('stores').select('is_admin').eq('user_id', session.user.id).single();
    if (!store?.is_admin) return showDenied('No sos administrador');
    
    document.getElementById('admin-loading')?.classList.add('hidden');
    document.getElementById('admin-content')?.classList.remove('hidden');
    loadUsers();
  }

  function showDenied(reason: string) {
    document.getElementById('admin-loading')?.classList.add('hidden');
    document.getElementById('admin-denied')?.classList.remove('hidden');
    const el = document.getElementById('denied-reason');
    if (el) el.textContent = reason;
  }

  async function loadUsers() {
    console.log('Cargando usuarios...');
    // Forzar recarga sin caché agregando timestamp
    const { data: stores, error } = await supabase
      .from('stores')
      .select('*, subscriptions(plan_id, status, store_id)')
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Error cargando usuarios:', error);
      alert('Error al cargar usuarios: ' + error.message);
      return;
    }

    console.log('Usuarios cargados:', stores?.length);
    console.log('Datos de usuarios (raw):', stores);
    console.log('Datos de usuarios (procesados):', stores?.map(s => {
      // subscriptions puede ser un objeto o un array dependiendo de la relación
      const sub = Array.isArray(s.subscriptions) ? s.subscriptions[0] : s.subscriptions;
      return {
        id: s.id,
        name: s.name,
        plan: sub?.plan_id || 'free',
        subscriptions: s.subscriptions,
        subType: Array.isArray(s.subscriptions) ? 'array' : typeof s.subscriptions
      };
    }));
    allUsers = stores || [];
    renderUsers(allUsers);
  }

  function renderUsers(users: any[]) {
    const tbody = document.getElementById('users-table');
    if (!tbody) return;

    if (users.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">No se encontraron usuarios</td></tr>';
      return;
    }

    tbody.innerHTML = users.map(store => {
      // subscriptions puede ser un objeto (relación 1:1) o un array
      const sub = Array.isArray(store.subscriptions) 
        ? store.subscriptions[0] 
        : store.subscriptions;
      const planId = sub?.plan_id || 'free';
      console.log(`Renderizando usuario ${store.name}: plan_id=${planId}, sub=`, sub, 'subscriptions type:', Array.isArray(store.subscriptions) ? 'array' : typeof store.subscriptions);
      const planBadge = getPlanBadge(planId);
      const date = new Date(store.created_at).toLocaleDateString('es-AR');
      
      return `
        <tr class="hover:bg-gray-700/50">
          <td class="px-6 py-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full flex items-center justify-center text-white font-medium">
                ${store.name?.[0]?.toUpperCase() || '?'}
              </div>
              <div>
                <p class="text-white font-medium">${store.name || 'Sin nombre'}</p>
                <p class="text-gray-500 text-sm">@${store.slug || 'sin-slug'}</p>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 text-gray-300">${store.contact_email || '-'}</td>
          <td class="px-6 py-4">${planBadge}</td>
          <td class="px-6 py-4 text-gray-400 text-sm">${date}</td>
          <td class="px-6 py-4">
            ${store.is_admin 
              ? '<span class="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs">Admin</span>' 
              : '<span class="text-gray-500 text-sm">-</span>'}
          </td>
          <td class="px-6 py-4">
            <div class="flex gap-2">
              <button onclick="toggleAdmin('${store.id}', ${!store.is_admin})" 
                class="px-3 py-1 text-xs ${store.is_admin ? 'bg-gray-600 hover:bg-gray-500' : 'bg-indigo-600 hover:bg-indigo-500'} text-white rounded">
                ${store.is_admin ? 'Quitar Admin' : 'Hacer Admin'}
              </button>
              <button onclick="changePlan('${store.id}')" 
                class="px-3 py-1 text-xs bg-emerald-600 hover:bg-emerald-500 text-white rounded">
                Cambiar Plan
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function getPlanBadge(plan: string) {
    const badges: Record<string, string> = {
      'free': '<span class="px-2 py-1 bg-gray-600 text-gray-300 rounded text-xs">Free</span>',
      'trial': '<span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded text-xs">Trial</span>',
      'premium': '<span class="px-2 py-1 bg-indigo-500/20 text-indigo-400 rounded text-xs">Premium</span>',
      'premium_annual': '<span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs">Premium Anual</span>',
    };
    return badges[plan] || badges['free'];
  }

  // Funciones globales
  (window as any).toggleAdmin = async (storeId: string, makeAdmin: boolean) => {
    if (!confirm(`¿Seguro que querés ${makeAdmin ? 'hacer admin' : 'quitar admin'} a este usuario?`)) return;
    
    const { error } = await supabase.from('stores').update({ is_admin: makeAdmin }).eq('id', storeId);
    if (error) {
      alert('Error: ' + error.message);
    } else {
      loadUsers();
    }
  };

  let currentModalStore: { id: string; plan: string; name: string } | null = null;
  let selectedPlan: string = '';

  function getPlanBadgeHTML(plan: string) {
    const badges: Record<string, string> = {
      'free': '<span class="px-2 py-1 bg-gray-600 text-gray-300 rounded text-xs">Free</span>',
      'trial': '<span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded text-xs">Trial</span>',
      'premium': '<span class="px-2 py-1 bg-indigo-500/20 text-indigo-400 rounded text-xs">Premium</span>',
      'premium_annual': '<span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs">Premium Anual</span>',
    };
    return badges[plan] || badges['free'];
  }

  function getPlanName(plan: string) {
    const names: Record<string, string> = {
      'free': 'Free',
      'trial': 'Trial',
      'premium': 'Premium',
      'premium_annual': 'Premium Anual',
    };
    return names[plan] || plan;
  }

  (window as any).changePlan = (storeId: string) => {
    const store = allUsers.find(u => u.id === storeId);
    if (!store) return;

    // subscriptions puede ser un objeto (relación 1:1) o un array
    const sub = Array.isArray(store.subscriptions) 
      ? store.subscriptions[0] 
      : store.subscriptions;
    const currentPlan = sub?.plan_id || 'free';
    currentModalStore = {
      id: storeId,
      plan: currentPlan,
      name: store.name || 'Sin nombre'
    };
    // NO resetear selectedPlan aquí, se inicializa pero se puede cambiar
    selectedPlan = currentPlan;
    console.log('Modal abierto - Plan actual:', currentPlan, 'selectedPlan inicial:', selectedPlan, 'sub:', sub);

    // Mostrar modal
    const modal = document.getElementById('change-plan-modal');
    const storeNameEl = document.getElementById('modal-store-name');
    const currentPlanEl = document.getElementById('modal-current-plan');
    const errorEl = document.getElementById('modal-error');
    const saveBtn = document.getElementById('save-plan-btn');

    if (modal && storeNameEl && currentPlanEl && errorEl && saveBtn) {
      storeNameEl.textContent = currentModalStore.name;
      currentPlanEl.innerHTML = `<p class="font-semibold text-white">${getPlanName(currentPlan)}</p>`;
      errorEl.classList.add('hidden');
      errorEl.textContent = '';
      
      // Reset selección
      document.querySelectorAll('.plan-option').forEach(btn => {
        const planId = (btn as HTMLElement).dataset.plan;
        if (planId === currentPlan) {
          btn.classList.add('border-indigo-500', 'bg-indigo-500/10');
          btn.classList.remove('border-gray-600', 'bg-gray-700/50');
        } else {
          btn.classList.remove('border-indigo-500', 'bg-indigo-500/10');
          btn.classList.add('border-gray-600', 'bg-gray-700/50');
        }
      });

      // Habilitar/deshabilitar botón
      saveBtn.disabled = true;
      if (selectedPlan !== currentPlan) {
        saveBtn.disabled = false;
      }

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
  };

  (window as any).selectPlan = (planId: string) => {
    selectedPlan = planId;
    console.log('Plan seleccionado:', planId, 'Plan actual del store:', currentModalStore?.plan);
    const saveBtn = document.getElementById('save-plan-btn');
    
    // Actualizar estilos de botones
    document.querySelectorAll('.plan-option').forEach(btn => {
      const btnPlanId = (btn as HTMLElement).dataset.plan;
      if (btnPlanId === planId) {
        btn.classList.add('border-indigo-500', 'bg-indigo-500/10');
        btn.classList.remove('border-gray-600', 'bg-gray-700/50');
      } else {
        btn.classList.remove('border-indigo-500', 'bg-indigo-500/10');
        btn.classList.add('border-gray-600', 'bg-gray-700/50');
      }
    });

    // Habilitar/deshabilitar botón guardar
    if (saveBtn && currentModalStore) {
      const isSamePlan = selectedPlan === currentModalStore.plan;
      saveBtn.disabled = isSamePlan;
      console.log('Botón guardar disabled:', isSamePlan, 'selectedPlan:', selectedPlan, 'currentPlan:', currentModalStore.plan);
    }
  };

  (window as any).closeChangePlanModal = () => {
    const modal = document.getElementById('change-plan-modal');
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    currentModalStore = null;
    selectedPlan = '';
  };

  (window as any).savePlanChange = async () => {
    console.log('savePlanChange llamado - currentModalStore:', currentModalStore, 'selectedPlan:', selectedPlan);
    
    if (!currentModalStore) {
      console.error('No hay currentModalStore');
      return;
    }
    
    if (!selectedPlan) {
      console.error('No hay selectedPlan');
      return;
    }
    
    if (selectedPlan === currentModalStore.plan) {
      console.log('El plan seleccionado es el mismo que el actual, no hacer nada');
      return;
    }

    const errorEl = document.getElementById('modal-error');
    const saveBtn = document.getElementById('save-plan-btn');
    
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.textContent = 'Guardando...';
    }

    if (errorEl) {
      errorEl.classList.add('hidden');
      errorEl.textContent = '';
    }

    try {
      // Obtener el token de la sesión
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.access_token) {
        throw new Error('No hay sesión activa. Por favor, recarga la página.');
      }

      // Capturar el valor actual de selectedPlan antes de hacer la petición
      const planToSave = selectedPlan;
      
      console.log('Cambiando plan:', { 
        storeId: currentModalStore.id, 
        planId: planToSave,
        currentPlan: currentModalStore.plan,
        selectedPlan: selectedPlan,
        'selectedPlan === currentPlan': selectedPlan === currentModalStore.plan
      });

      if (planToSave === currentModalStore.plan) {
        throw new Error('No se puede cambiar al mismo plan');
      }

      const response = await fetch('/api/admin/change-plan', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${session.access_token}`
        },
        credentials: 'include',
        body: JSON.stringify({
          storeId: currentModalStore.id,
          planId: planToSave
        })
      });

      const data = await response.json();
      console.log('Respuesta API:', { status: response.status, data });

      if (!response.ok) {
        throw new Error(data.error || 'Error al cambiar el plan');
      }

      // Cerrar modal y recargar
      (window as any).closeChangePlanModal();
      
      // Esperar un poco antes de recargar para asegurar que la BD se actualizó
      // Recargar múltiples veces para asegurar que se actualice
      setTimeout(() => {
        loadUsers();
      }, 300);
      setTimeout(() => {
        loadUsers();
      }, 1000);
    } catch (err: any) {
      console.error('Error al cambiar plan:', err);
      if (errorEl) {
        errorEl.textContent = err.message || 'Error al cambiar el plan';
        errorEl.classList.remove('hidden');
      }
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Cambiar Plan';
      }
    }
  };

  // Búsqueda
  document.getElementById('search-input')?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase();
    const filtered = allUsers.filter(u => 
      u.name?.toLowerCase().includes(query) || 
      u.contact_email?.toLowerCase().includes(query) ||
      u.slug?.toLowerCase().includes(query)
    );
    renderUsers(filtered);
  });

  checkAdmin();
</script>
