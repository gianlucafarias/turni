---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Cupones - Admin">
  <div id="admin-loading" class="min-h-screen bg-gray-900 flex items-center justify-center">
    <div class="w-10 h-10 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
  </div>

  <div id="admin-denied" class="min-h-screen bg-gray-900 flex items-center justify-center hidden">
    <div class="text-center p-6">
      <h1 class="text-2xl font-bold text-red-500 mb-4">Acceso Denegado</h1>
      <p id="denied-reason" class="text-gray-400 mb-6"></p>
      <a href="/dashboard" class="px-6 py-3 bg-indigo-600 text-white rounded-lg">Volver</a>
    </div>
  </div>

  <div id="admin-content" class="min-h-screen bg-gray-900 hidden">
    <div class="flex">
      <!-- Sidebar -->
      <aside class="w-64 min-h-screen bg-gray-800 border-r border-gray-700 fixed">
        <div class="p-4 border-b border-gray-700">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-orange-500 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
            <div>
              <h1 class="font-bold text-white">Admin Panel</h1>
              <p class="text-xs text-gray-400">Tiendita</p>
            </div>
          </div>
        </div>
        <nav class="p-4 space-y-1">
          <a href="/admin" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-300 hover:bg-gray-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
            Dashboard
          </a>
          <a href="/admin/users" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-300 hover:bg-gray-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
            Usuarios
          </a>
          <a href="/admin/subscriptions" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-300 hover:bg-gray-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
            Suscripciones
          </a>
          <a href="/admin/coupons" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium bg-indigo-600 text-white">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg>
            Cupones
          </a>
          <a href="/admin/plans" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-300 hover:bg-gray-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
            Planes
          </a>
          <div class="pt-4 mt-4 border-t border-gray-700">
            <a href="/dashboard" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-400 hover:bg-gray-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>
              Volver al Dashboard
            </a>
          </div>
        </nav>
      </aside>
      
      <!-- Main -->
      <main class="flex-1 ml-64 p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Gestión de Cupones</h2>
          <button id="create-coupon-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            Crear Cupón
          </button>
        </div>

        <!-- Modal crear cupón -->
        <div id="create-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
          <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md border border-gray-700">
            <h3 class="text-xl font-bold text-white mb-4">Crear Cupón</h3>
            <form id="coupon-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Código</label>
                <input type="text" name="code" required placeholder="DESCUENTO20" 
                  class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white uppercase">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Tipo de Descuento</label>
                <select name="discount_type" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                  <option value="percentage">Porcentaje (%)</option>
                  <option value="fixed">Monto Fijo ($)</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Valor</label>
                <input type="number" name="discount_value" required placeholder="20" 
                  class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Usos Máximos (0 = ilimitado)</label>
                <input type="number" name="max_uses" value="0" 
                  class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Válido Hasta</label>
                <input type="date" name="valid_until" 
                  class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
              </div>
              <div class="flex gap-2 pt-4">
                <button type="button" id="cancel-modal" class="flex-1 px-4 py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600">
                  Cancelar
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-500">
                  Crear
                </button>
              </div>
            </form>
          </div>
        </div>
        
        <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-700/50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Código</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Descuento</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Usos</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Válido Hasta</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Estado</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Acciones</th>
              </tr>
            </thead>
            <tbody id="coupons-table" class="divide-y divide-gray-700">
              <tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Cargando...</td></tr>
            </tbody>
          </table>
        </div>
      </main>
    </div>
  </div>
</Layout>

<script>
  import { createClient } from '@supabase/supabase-js';
  
  const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY
  );

  async function checkAdmin() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return showDenied('No hay sesión activa');
    
    const { data: store } = await supabase.from('stores').select('is_admin').eq('user_id', session.user.id).single();
    if (!store?.is_admin) return showDenied('No sos administrador');
    
    document.getElementById('admin-loading')?.classList.add('hidden');
    document.getElementById('admin-content')?.classList.remove('hidden');
    loadCoupons();
  }

  function showDenied(reason: string) {
    document.getElementById('admin-loading')?.classList.add('hidden');
    document.getElementById('admin-denied')?.classList.remove('hidden');
    const el = document.getElementById('denied-reason');
    if (el) el.textContent = reason;
  }

  async function loadCoupons() {
    const { data: coupons } = await supabase
      .from('coupons')
      .select('*')
      .order('created_at', { ascending: false });

    const tbody = document.getElementById('coupons-table');
    if (!tbody) return;

    if (!coupons?.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">No hay cupones. Creá uno nuevo.</td></tr>';
      return;
    }

    tbody.innerHTML = coupons.map(c => {
      const discount = c.discount_type === 'percentage' 
        ? `${c.discount_value}%` 
        : `$${c.discount_value}`;
      const uses = c.max_uses ? `${c.times_used || 0}/${c.max_uses}` : `${c.times_used || 0}/∞`;
      const validUntil = c.valid_until ? new Date(c.valid_until).toLocaleDateString('es-AR') : 'Sin límite';
      const isExpired = c.valid_until && new Date(c.valid_until) < new Date();
      
      const statusBadge = !c.active 
        ? '<span class="px-2 py-1 bg-gray-600 text-gray-300 rounded text-xs">Inactivo</span>'
        : isExpired 
          ? '<span class="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs">Expirado</span>'
          : '<span class="px-2 py-1 bg-emerald-500/20 text-emerald-400 rounded text-xs">Activo</span>';
      
      return `
        <tr class="hover:bg-gray-700/50">
          <td class="px-6 py-4">
            <span class="font-mono text-white bg-gray-700 px-2 py-1 rounded">${c.code}</span>
          </td>
          <td class="px-6 py-4 text-emerald-400 font-medium">${discount}</td>
          <td class="px-6 py-4 text-gray-300">${uses}</td>
          <td class="px-6 py-4 text-gray-400 text-sm">${validUntil}</td>
          <td class="px-6 py-4">${statusBadge}</td>
          <td class="px-6 py-4">
            <div class="flex gap-2">
              <button onclick="toggleCoupon('${c.id}', ${!c.active})" 
                class="px-3 py-1 text-xs ${c.active ? 'bg-gray-600 hover:bg-gray-500' : 'bg-emerald-600 hover:bg-emerald-500'} text-white rounded">
                ${c.active ? 'Desactivar' : 'Activar'}
              </button>
              <button onclick="deleteCoupon('${c.id}')" 
                class="px-3 py-1 text-xs bg-red-600 hover:bg-red-500 text-white rounded">
                Eliminar
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  // Modal
  const modal = document.getElementById('create-modal');
  document.getElementById('create-coupon-btn')?.addEventListener('click', () => modal?.classList.remove('hidden'));
  document.getElementById('cancel-modal')?.addEventListener('click', () => modal?.classList.add('hidden'));

  // Crear cupón
  document.getElementById('coupon-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    
    const coupon = {
      code: (formData.get('code') as string).toUpperCase(),
      discount_type: formData.get('discount_type'),
      discount_value: Number(formData.get('discount_value')),
      max_uses: Number(formData.get('max_uses')) || null,
      valid_until: formData.get('valid_until') || null,
    };

    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      alert('No hay sesión activa');
      return;
    }

    const response = await fetch('/api/admin/coupons', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include',
      body: JSON.stringify(coupon)
    });

    const result = await response.json();

    if (!response.ok) {
      alert('Error: ' + (result.error || 'Error al crear el cupón'));
    } else {
      modal?.classList.add('hidden');
      form.reset();
      loadCoupons();
    }
  });

  (window as any).toggleCoupon = async (id: string, activate: boolean) => {
    const response = await fetch('/api/admin/coupons', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ id, active: activate })
    });

    const result = await response.json();
    if (!response.ok) {
      alert('Error: ' + (result.error || 'Error al actualizar el cupón'));
    } else {
      loadCoupons();
    }
  };

  (window as any).deleteCoupon = async (id: string) => {
    if (!confirm('¿Eliminar este cupón?')) return;
    
    const response = await fetch('/api/admin/coupons', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ id })
    });

    const result = await response.json();
    if (!response.ok) {
      alert('Error: ' + (result.error || 'Error al eliminar el cupón'));
    } else {
      loadCoupons();
    }
  };

  checkAdmin();
</script>
