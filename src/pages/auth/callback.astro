---
import { supabase } from '../../lib/supabase';

// Obtener el código de la URL
const code = Astro.url.searchParams.get('code');

if (code) {
  const { data, error } = await supabase.auth.exchangeCodeForSession(code);

  // #region agent log
  fetch('http://127.0.0.1:7242/ingest/b0f55e3a-8eac-449f-96b7-3ed570a5511d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'pre-fix',hypothesisId:'H2',location:'src/pages/auth/callback.astro:9',message:'Supabase exchange code result',data:{hasError:!!error,hasSession:!!data?.session},timestamp:Date.now()})}).catch(()=>{});
  // #endregion
  
  if (!error && data?.session) {
    // Si el usuario está verificado, redirigir a setup de tienda
    return Astro.redirect('/setup/store');
  }
}

// Si hay error o no hay código, redirigir al login
return Astro.redirect('/login');
---