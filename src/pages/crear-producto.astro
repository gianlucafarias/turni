---
import Layout from '../layouts/Layout.astro';
import FormField from '../components/ui/FormField.astro';
import TextArea from '../components/ui/TextArea.astro';
import Select from '../components/ui/Select.astro';
import Button from '../components/ui/Button.astro';
import FileUpload from '../components/ui/FileUpload.astro';
import ProgressSteps from '../components/ui/ProgressSteps.astro';
import PricingCard from '../components/ui/PricingCard.astro';
import PaymentStep from '../components/ui/PaymentStep.astro';
import { CONFIG } from '../config';

const { publicationSteps, publicationPlans, categorias } = CONFIG;

// Convertir categorías para el Select
const categoryOptions = categorias.map(cat => ({
    value: cat.id.toString(),
    label: cat.nombre
}));

// Convertir planes para PricingCard
const pricingFeatures = publicationPlans.map(plan => ({
    id: plan.id,
    name: plan.nombre,
    price: plan.precio,
    duration: plan.duracion,
    features: plan.caracteristicas.map(text => ({ text, included: true })),
    highlighted: plan.destacado
}));

// Datos iniciales para el paso de pago
const initialProductData = {
    nombre: '',
    precio: 0
};

const initialPlanData = {
    nombre: '',
    precio: 0
};
---

<Layout title="Crear Nuevo Producto">
    <ProgressSteps steps={publicationSteps} currentStep={1} />

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Paso 1: Información del Producto -->
        <div id="step-1" class="bg-white rounded-2xl shadow-xl p-8 md:p-10">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Información del Producto</h1>
            <p class="text-gray-600 mb-8">Complete los detalles de su producto para continuar</p>

            <form id="producto-form" class="space-y-8">
                <!-- Información Básica -->
                <div class="space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-2">
                        <span class="text-indigo-600">01.</span> Información Básica
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <FormField
                            label="Nombre del Producto"
                            name="nombre"
                            required={true}
                            placeholder="Ej: iPhone 12 Pro"
                        />
                        
                        <Select
                            label="Categoría"
                            name="categoria"
                            options={categoryOptions}
                            required={true}
                            placeholder="Seleccionar categoría"
                        />
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Select
                            label="Estado"
                            name="estado"
                            options={[
                                { value: 'usado', label: 'Usado' },
                                { value: 'nuevo', label: 'Nuevo' },
                                { value: 'reacondicionado', label: 'Reacondicionado' }
                            ]}
                            required={true}
                            placeholder="Seleccionar estado"
                        />

                        <FormField
                            label="Ubicación"
                            name="ubicacion"
                            required={true}
                            placeholder="Ej: Belgrano, CABA"
                        />
                    </div>

                    <TextArea
                        label="Descripción"
                        name="descripcion"
                        required={true}
                        placeholder="Describe el estado del producto, detalles importantes y forma de entrega..."
                        rows={4}
                    />
                </div>

                <!-- Precios y Stock -->
                <div class="space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-2">
                        <span class="text-indigo-600">02.</span> Precio
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <FormField
                            label="Precio"
                            name="precio"
                            type="number"
                            required={true}
                            min={0}
                            step="0.01"
                            placeholder="0.00"
                        />

                        <FormField
                            label="Precio Anterior (opcional)"
                            name="precioAnterior"
                            type="number"
                            min={0}
                            step="0.01"
                            placeholder="0.00"
                        />
                    </div>
                </div>

                <!-- Características -->
                <div class="space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-2">
                        <span class="text-indigo-600">03.</span> Características
                    </h2>
                    
                    <div id="caracteristicas-container" class="space-y-3">
                        <div class="flex gap-3">
                            <FormField
                                name="caracteristicas[]"
                                placeholder="Ej: Pantalla AMOLED 6.5"
                                className="flex-1"
                            />
                            <Button
                                type="button"
                                variant="primary"
                                onClick="agregarCaracteristica()"
                            >
                                Agregar
                            </Button>
                        </div>
                    </div>
                </div>

                <!-- Imágenes -->
                <div class="space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-2">
                        <span class="text-indigo-600">04.</span> Imágenes
                    </h2>
                    
                    <FileUpload
                        label="Imagen del Producto"
                        name="imagen"
                        required={true}
                        accept="image/*"
                        maxSize={10 * 1024 * 1024}
                    />
                </div>

                <!-- Información de Contacto -->
                <div class="space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-2">
                        <span class="text-indigo-600">05.</span> Información de Contacto
                    </h2>
                    
                    <FormField
                        label="Número de WhatsApp"
                        name="whatsapp"
                        type="tel"
                        required={true}
                        pattern="[0-9]{10,15}"
                        placeholder="549XXXXXXXXXX"
                    />
                </div>

                <div class="flex justify-end space-x-4 pt-6">
                    <Button
                        type="button"
                        variant="secondary"
                        onClick="history.back()"
                    >
                        Cancelar
                    </Button>
                    <Button
                        type="submit"
                        variant="primary"
                    >
                        Continuar
                    </Button>
                </div>
            </form>
        </div>

        <!-- Paso 2: Planes de Publicación -->
        <div id="step-2" class="hidden">
            <h2 class="text-3xl font-bold text-center mb-12">Elige tu Plan de Publicación</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                {publicationPlans.map(plan => (
                    <PricingCard
                        id={plan.id}
                        name={plan.nombre}
                        price={plan.precio}
                        duration={plan.duracion}
                        features={plan.caracteristicas.map(text => ({ text, included: true }))}
                        highlighted={plan.destacado}
                    />
                ))}
            </div>
        </div>

        <!-- Paso 3: Pago y Publicación -->
        <div id="step-3" class="hidden">
            <PaymentStep
                productData={initialProductData}
                planData={initialPlanData}
                whatsappNumber={CONFIG.whatsappNumber}
            />
        </div>
    </div>
</Layout>

<script>
    import { publicationStore } from '../store/publicationStore';
    import { 
        initializeImageUpload, 
        initializeFormValidation, 
        initializeCharacteristics 
    } from '../utils/formHandlers';
    import { showNotification } from '../utils/notifications';

    document.addEventListener('DOMContentLoaded', () => {
        initializeImageUpload();
        initializeFormValidation();
        initializeCharacteristics();

        // Actualizar datos cuando cambiamos al paso 3
        publicationStore.onStepChange((step) => {
            if (step === 3) {
                const productData = publicationStore.getProductData();
                const selectedPlan = publicationStore.getSelectedPlan();
                
                if (productData && selectedPlan) {
                    const paymentStep = document.getElementById('step-3');
                    if (paymentStep) {
                        // Actualizar los datos en el componente PaymentStep
                        const paymentSummary = paymentStep.querySelector('payment-summary');
                        if (paymentSummary) {
                            paymentSummary.setAttribute('product-name', productData.nombre);
                            paymentSummary.setAttribute('product-price', productData.precio.toString());
                            paymentSummary.setAttribute('plan-name', selectedPlan.nombre);
                            paymentSummary.setAttribute('plan-price', selectedPlan.precio.toString());
                        }
                    }
                }
            }
        });
    });

    // Exponer funciones necesarias globalmente
    (window as any).agregarCaracteristica = () => {
        const container = document.getElementById('caracteristicas-container');
        if (container) {
            const newField = document.createElement('div');
            newField.className = 'flex gap-3';
            newField.innerHTML = `
                <input 
                    type="text" 
                    name="caracteristicas[]" 
                    class="flex-1 px-4 py-3 rounded-xl border-2 border-gray-200 focus:ring-0 focus:border-indigo-500 transition-colors"
                    placeholder="Ej: Pantalla AMOLED 6.5"
                />
                <button 
                    type="button"
                    class="px-4 py-2 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition-colors"
                    onclick="this.parentElement.remove()"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            `;
            container.appendChild(newField);
        }
    };

    (window as any).selectPlan = (planId: string, precio: number) => {
        publicationStore.setPlan({ id: planId, precio });
        publicationStore.setStep(3);
    };
</script> 